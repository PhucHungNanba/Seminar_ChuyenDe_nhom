@inject ApiService ApiService
@inject ILogger<CommentInput> Logger

<div class="comment-input-container">
    <h4>Add a Comment</h4>
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-alert">
            <span class="error-icon">âš </span>
            <span>@errorMessage</span>
        </div>
    }

    <EditForm Model="commentRequest" OnValidSubmit="HandleSubmitAsync" FormName="@($"CommentForm_{PostId}")">
        <DataAnnotationsValidator />
        
        <div class="form-group">
            <label for="comment-username">Username:</label>
            <InputText @bind-Value="commentRequest.Username" id="comment-username" class="form-control" placeholder="Your username" />
            <ValidationMessage For="() => commentRequest.Username" />
        </div>
        
        <div class="form-group">
            <label for="comment-content">Comment:</label>
            <InputTextArea @bind-Value="commentRequest.Content" id="comment-content" class="form-control" rows="3" placeholder="Write your comment..." />
            <ValidationMessage For="() => commentRequest.Content" />
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-sm" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-small"></span>
                    <span>Adding...</span>
                }
                else
                {
                    <span>Add Comment</span>
                }
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public int PostId { get; set; }
    [Parameter] public EventCallback OnCommentAdded { get; set; }

    private CreateCommentRequest commentRequest = new();
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    private async Task HandleSubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(commentRequest.Username) || string.IsNullOrWhiteSpace(commentRequest.Content))
        {
            errorMessage = "Username and comment are required";
            return;
        }

        try
        {
            isSubmitting = true;
            errorMessage = string.Empty;
            
            await ApiService.CreateCommentAsync(PostId, commentRequest);
            
            // Clear form
            commentRequest = new CreateCommentRequest();
            
            // Notify parent component
            await OnCommentAdded.InvokeAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create comment for post {PostId}", PostId);
            errorMessage = "Failed to add comment. Please try again.";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}